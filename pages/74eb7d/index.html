<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>优化性能 | Broad</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/logo3.png">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_3077305_pt8umhrn4k9.css">
    <meta name="description" content="在工作中收集知识，做此纪录">
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <link rel="preload" href="/assets/css/0.styles.c1a44184.css" as="style"><link rel="preload" href="/assets/js/app.ddf09a0a.js" as="script"><link rel="preload" href="/assets/js/2.ea93b1fa.js" as="script"><link rel="preload" href="/assets/js/3.485ed5de.js" as="script"><link rel="prefetch" href="/assets/js/10.03e74bb9.js"><link rel="prefetch" href="/assets/js/11.841cb7fa.js"><link rel="prefetch" href="/assets/js/12.11736aca.js"><link rel="prefetch" href="/assets/js/13.2ec69eb9.js"><link rel="prefetch" href="/assets/js/14.1debe72c.js"><link rel="prefetch" href="/assets/js/15.c9e8b826.js"><link rel="prefetch" href="/assets/js/16.f5a32aba.js"><link rel="prefetch" href="/assets/js/17.063217e5.js"><link rel="prefetch" href="/assets/js/18.fc6708a0.js"><link rel="prefetch" href="/assets/js/19.c560d28f.js"><link rel="prefetch" href="/assets/js/20.cf4f8cae.js"><link rel="prefetch" href="/assets/js/21.5d92fd44.js"><link rel="prefetch" href="/assets/js/22.02b5d656.js"><link rel="prefetch" href="/assets/js/23.cd47652a.js"><link rel="prefetch" href="/assets/js/24.a4fe0acc.js"><link rel="prefetch" href="/assets/js/25.93808849.js"><link rel="prefetch" href="/assets/js/26.95559e94.js"><link rel="prefetch" href="/assets/js/27.5b52f274.js"><link rel="prefetch" href="/assets/js/28.f225b586.js"><link rel="prefetch" href="/assets/js/29.1837e01e.js"><link rel="prefetch" href="/assets/js/30.1d70b981.js"><link rel="prefetch" href="/assets/js/31.e4fbe2dd.js"><link rel="prefetch" href="/assets/js/32.cb3abc04.js"><link rel="prefetch" href="/assets/js/33.4d68ef67.js"><link rel="prefetch" href="/assets/js/34.1b693dfa.js"><link rel="prefetch" href="/assets/js/35.b5a5be4c.js"><link rel="prefetch" href="/assets/js/36.fd8c12a9.js"><link rel="prefetch" href="/assets/js/37.f07c0073.js"><link rel="prefetch" href="/assets/js/38.49cacace.js"><link rel="prefetch" href="/assets/js/39.b0d9e644.js"><link rel="prefetch" href="/assets/js/4.af3a7079.js"><link rel="prefetch" href="/assets/js/40.175bb94c.js"><link rel="prefetch" href="/assets/js/41.ba88057e.js"><link rel="prefetch" href="/assets/js/42.b3cff7e4.js"><link rel="prefetch" href="/assets/js/43.fc8f6a12.js"><link rel="prefetch" href="/assets/js/44.e7d17b6d.js"><link rel="prefetch" href="/assets/js/45.01da0606.js"><link rel="prefetch" href="/assets/js/46.f18f9515.js"><link rel="prefetch" href="/assets/js/47.ab18b92d.js"><link rel="prefetch" href="/assets/js/48.2c14b3cc.js"><link rel="prefetch" href="/assets/js/49.9d2a9e0b.js"><link rel="prefetch" href="/assets/js/5.729ea376.js"><link rel="prefetch" href="/assets/js/6.bbf92768.js"><link rel="prefetch" href="/assets/js/7.fe4d294f.js"><link rel="prefetch" href="/assets/js/8.7ea0e27c.js"><link rel="prefetch" href="/assets/js/9.a692a315.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c1a44184.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo3.png" alt="Broad" class="logo"> <span class="site-name can-hide">Broad</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/java/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/RabbitMq/" class="nav-link">中间件</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/ui/" class="nav-link">前端</a></div><div class="nav-item"><a href="/technology/" class="nav-link">杂文</a></div><div class="nav-item"><a href="/BaGuWen/" class="nav-link">八股文</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Broad-CanDou/broad" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="/otherImg/peolo.jpg"> <div class="blogger-info"><h3>Wang Bu Zheng</h3> <span>开发农名工</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><a href="/java/" class="link-title">后端</a> <span class="title" style="display:none;">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>学习笔记</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/RabbitMq/" class="nav-link">中间件</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/ui/" class="nav-link">前端</a></div><div class="nav-item"><a href="/technology/" class="nav-link">杂文</a></div><div class="nav-item"><a href="/BaGuWen/" class="nav-link">八股文</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/Broad-CanDou/broad" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Mysql</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1ef4bf/" class="sidebar-link">索引</a></li><li><a href="/pages/74eb7d/" aria-current="page" class="active sidebar-link">优化性能</a></li><li><a href="/pages/98f273/" class="sidebar-link">Mysql事务</a></li><li><a href="/pages/84266c/" class="sidebar-link">杂文面试题</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper bg-style-4"><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/BaGuWen/#八股文" data-v-06225672>八股文</a></li><li data-v-06225672><a href="/BaGuWen/#Mysql" data-v-06225672>Mysql</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/Broad-CanDou" target="_blank" title="作者" class="beLink" data-v-06225672>WangBuZheng</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-05-20</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">优化性能<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="sql性能优化"><a href="#sql性能优化" class="header-anchor">#</a> SQL性能优化</h1> <h2 id="_1-sql级别-如何优化、解决、避免sql效率问题"><a href="#_1-sql级别-如何优化、解决、避免sql效率问题" class="header-anchor">#</a> 1.sql级别[如何优化、解决、避免sql效率问题]</h2> <h3 id="如何定位执行慢的sql-慢查询"><a href="#如何定位执行慢的sql-慢查询" class="header-anchor">#</a> 如何定位执行慢的SQL：慢查询</h3> <p><strong>面试官:</strong> 你通常都是如何定位执行慢的sql的？</p> <p><strong>我:</strong> 通常要定位慢sql的话，一般我会开启<strong>慢查询日志</strong><br></p> <ol><li>可以查看数据库慢查询日志是否开启 命令: <strong>slow variables like '%slow_query_log'</strong><br> <img src="/assets/img/slow_query_log.60eb6823.png">
命令: <strong>slow variables like '%slow_query_log%'</strong> 显示日志存储的位置。
<img src="/assets/img/slow_query_log1.9e76a98f.png"></li></ol> <p>此时是关闭的 打开命令: <strong>set slow_query_log=on</strong> <br>
2. 同时可以查看慢查询时间阈值 命令: <strong>show variables like '%long_query_time'</strong> <img src="/assets/img/long_query_time.19aa3fe4.png">
默认十秒中，设置时间命令: <strong>set long_query_time=2</strong></p> <ol start="3"><li>打开慢查询日志并设置好时间后，使用慢查询日志分析工具: <strong>mysqldumpslow</strong> 执行的话需要退出mysql环境。/data/LAPTOP-PVKIO0GI-slow.log 是存日志的路径。
<strong>mysqldumpslow -s t -t 5 /data/LAPTOP-PVKIO0GI-slow.log</strong></li></ol> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>-s: 是排序的意思  按照何种规则排序。
-t: 是返回几条的意思。</p></div> <br> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>开启慢查询日志会多少带来性能的影响，所以一般调优的时候才开启。</p></div> <h3 id="平常如何查看是否使用到索引呢"><a href="#平常如何查看是否使用到索引呢" class="header-anchor">#</a> 平常如何查看是否使用到索引呢？</h3> <p>使用 <strong>EXPLAIN/DECSRIBE</strong>(两者效果一样) 这两个对sql进行分析。</p> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>使用后我们可以观察：<br> <strong>key列:</strong> 因为他是实际用到的索引值。<br> <strong>type列:</strong> 此列表示关联类型或访问类型。也就是MySQL决定如何查找表中的行。依次从最优到最差分别为：system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; all。</p></div> <h3 id="避免索引失效-导致全盘扫描"><a href="#避免索引失效-导致全盘扫描" class="header-anchor">#</a> 避免索引失效，导致全盘扫描</h3> <ol><li>计算/函数/类型转换导致索引失效</li> <li>范围条件右边的列索引失效(联合索引时 碰到范围查询比如 &gt; &lt;&gt;,右边那列索引失效)</li> <li>使用符号!=/&lt;&gt;索引失效。</li> <li>使用 is null索引生效，is not null 索引失效。</li> <li>like 以通配符百分号%开头索引失效  比如(like '%aa')</li> <li>OR 前后存在非索引列，索引失效。(必须保证前后都有索引)</li></ol> <h2 id="_2-数据库级别-数据库层面优化sql效率"><a href="#_2-数据库级别-数据库层面优化sql效率" class="header-anchor">#</a> 2.数据库级别[数据库层面优化sql效率]</h2> <h3 id="binlog日志"><a href="#binlog日志" class="header-anchor">#</a> binlog日志</h3> <ol><li><strong>数据库中binlog日志有什么作用及应用场景？</strong></li></ol> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>binlog日志即二进制日志文件，它记录了数据库所有执行 DDL,DML等数据库更新事件的语句。
但不包括查询(select)show语句。</p></div> <p><strong>应用场景</strong><br></p> <ul><li>用于 <strong>数据恢复:</strong> Mysql服务器意外的停止，可以通过二进制文件来查看有哪些操作对此恢复数据。</li> <li>用于 <strong>数据复制:</strong> 用于主从复制方面。</li></ul> <p>对于Mysql数据库的数据备份,主从,主主,主备都离不开binlog，需要它同步数据。保证数据的一致。</p> <ol start="2"><li><strong>如何使用binlog日志</strong></li></ol> <ul><li><strong>SHOW BINARY LOGS:</strong> 显示服务器现有的二进制日志信息。</li> <li><strong>flush logs:</strong> flush刷新log日志，自此刻开始产生一个新编号的binlog日志文件。</li> <li><strong>show master status:</strong> 即最后（最新）一个binlog日志的编号名称</li> <li><strong>reset master:</strong> 重置（清空）所有binlog日志</li> <li><strong>purge master logs to '文件名':</strong> 删除此文件之前的日志文件。</li> <li>通过<strong>show variables like '%log_bin%':</strong> 命令查看binlog是否开启，若是没开启可以通过配置文件开启。</li></ul> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>找到 mysql中<strong>my.cnf</strong> 配置文件配置一下内容<br>
log-bin=xxx 日志文件名<br>
binlog_expire_logs_seconds=60000 文件的保留时间<br>
max_binlog_size=100M   文件上限大小,默认1GB<br>
配置完成后 <strong>service mysqld restart</strong> 重启。</p></div> <ul><li><strong>如何查看binlog日志内容？</strong></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>  1. 通过 mysqlbinlog -v '日志文件路径' 命令查看。
  2. 通过以上命令读取的内容比较多 不利于查看不容易分辨。我们可以通过命令:
  show binlog events [IN 'log_name'] [FROM pos] [LIMIT [offset,] row_count];查看
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><p><strong>IN 'log_name'</strong>: 指定查询的binlog文件名(不指定就是第一个binlog文件)</p></li> <li><p><strong>FROM pos</strong>: 指定从哪个pos起始点查(不指定就是从整个文件pos点开始算)</p></li> <li><p><strong>LIMIT [offset]</strong>: 偏移量。</p></li> <li><p><strong>row_count</strong>: 查询总条数。
如下图所示  我们根据 show binlog 命令查出信息:
<img src="/assets/img/show_binlog.9c1e2a2d.png">
如上图所示: 知道开始的 pos和结束的pos。我们通过命令:<br></p></li> <li><p><strong>数据恢复命令</strong> <strong>mysqlbinlog --start-position=开始的pos --stop-position=结束的pos --database=要操作的数据库 binlog的名称 | mysql -u登陆名 -p登陆密码 -v 要操作的数据库</strong></p></li> <li><p><strong>最终执行命令(我的)</strong> <strong>mysqlbinlog --start-position=560 --stop-position=771 --database=my_test binlog.000033 | mysql -uroot -p123456 -v my_test</strong></p></li></ul> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>此命令进入到 binlog 目录下执行，而不是在mysql中。列如: cd /var/lib/mysql</p></div> <h3 id="主从复制层面优化性能"><a href="#主从复制层面优化性能" class="header-anchor">#</a> 主从复制层面优化性能</h3> <ul><li><p>主从复制原理
从机(slave)读取主机(master)binlig日志来同步数据。那主要靠着以下三个线程。</p> <ul><li><strong>二进制日志转储线程(Binlog dump thread):</strong> 它是一个主库线程，当从库线程连接的时候，主库可以将二进制日志发送给从库，当主库读取时间(Event) 的时候，会在binlog枷锁，读取完成之后在将锁释放掉。</li> <li><strong>从库I/O线程:</strong> 会连接到主库,向主库发动请求更新binlog。这时从库的I/O线程就可以读取到主库二进制日志转储线程发送的Binlog更新部分，并且拷贝到本地的中继日志(Relay log)。</li> <li><strong>从库 sql 线程:</strong> 会读取从库中的中继日志，并且执行日志中的事件，将从库的数据与主库保持同步。
<img src="/assets/img/主从复制.2402bcc8.png"> <strong>总结:</strong> 二进制日志转储线程 发送二进制日志(binlog)到从机(slave)。从机从库I/O线程接收并写入到中继日志(Relay log)。然后从库 sql 线程会对中继日志读取。以至于保持从库与主库数据保持一致。</li></ul></li> <li><p><strong>主从复制搭建</strong></p> <ul><li><strong>Master主机配置</strong> <ul><li>my.cnf 配置文件 配置一下属性:<br> <table><thead><tr><th>属性</th> <th>描述</th></tr></thead> <tbody><tr><td>server-id</td> <td>主服务器唯一标识 列如: server-id=1 <strong>必选参数</strong></td></tr> <tr><td>log-bin</td> <td>启用二进制日志，指名路径 <strong>必选参数</strong></td></tr> <tr><td>read-only</td> <td>0表示读写(主机) 1表示只读(从机) <strong>可选参数</strong></td></tr> <tr><td>binlog_expire_logs_seconds</td> <td>日志文件保留的时长 单位秒 <strong>可选参数</strong></td></tr> <tr><td>max_binlog_size</td> <td>二进制日志大小 此参数最大默认值时1GB <strong>可选参数</strong></td></tr> <tr><td>binlog-ignore-db</td> <td>不要复制的数据库<strong>可选参数</strong></td></tr> <tr><td>binlog-do-db</td> <td>需要复制的数据库 <strong>可选参数</strong></td></tr> <tr><td>binlog_format</td> <td>binlog格式 列如: binlig_format=STATEMENT <strong>可选参数</strong></td></tr></tbody></table>
配置完后重启主机服务 <strong>systemctl restart mysqld</strong></li> <li><strong>主机建立账户并授权</strong><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>如果是Mysql8 执行以下命令语句:<br> <strong>CREATE USER 'slave'@'%' IDENTIFIED BY '123456';</strong><br> <strong>GRANT REPLICACTION SLAVE  ON  <em>.</em> TO 'slave'@'%';</strong><br> <strong>ALTER USER 'slave'@'%' IDENTIFIED WITH  mysql_native_password BY '123456';</strong></p></div> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>如果是Mysql5/7 执行以下命令语句:<br> <strong>GRANT REPLICACTION SLAVE  ON  <em>.</em> TO 'slave'@'从机数据库Ip' IDENTIFIED BY '123456';</strong></p></div> <strong>执行完之后刷新权限: flush privileges;</strong></li></ul></li></ul> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>在主机刷新权限后: 执行<strong>show master status</strong>记录其中position的值
<img src="/assets/img/show_master_status.7a20e6b0.png"></p></div> <ul><li><strong>Slave从机配置</strong> <ul><li>执行语句:<br> <strong>CHANGE MASTER TO MASTER_HOST='主机IP地址' MASTER_USER='主机用户名' MASTER_PASSWORD='主机用户名的密码' MASTER_LOG_FILE='日志文件名' MASTER_LOG_POS=具体position的值(就是 show master status后的position值)</strong></li> <li>执行语句 <strong>start slave;</strong> 启动slave同步</li> <li>执行语句 <strong>show slave status\G;</strong> 如下图红框内 出现yes则成功。
<img src="/assets/img/show_slave_status.6bef03c0.png"></li></ul></li></ul></li> <li><p><strong>如何保证数据一致性?</strong></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>  虽然我们搭建了主从复制，但是我们要考虑如何保持数据的一致性(也就是主机和从机的数据保持一致)。
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>异步复制:<br>
  Mysql中默认。在主库完成写入binlog日志中提交完事务后，就返回客户端。不用等待从库返回结果。那这样不会影响到主库的写入的效率，但是一旦主库宕机，从库这时还没收到binlog日志。那么造成数据丢失。</li> <li>半同步复制: <br>
  在异步复制时主库提交完事务后返回了客户端，而半同步复制还是转发到从库然后一系列的从库执行。当有从库执行完后会ACK
通知主库。这样保证了数据的一致性。但是！！注意这句话 当有从库执行完后，也就是说从库不止一台。那不能就一台从库完成了然后ack通知一下 那其他的还没执行。所以在Mysql5.7版本中增加一个<strong>rpl_semi_sync_master_wait_for_slave_count</strong>参数。可以对应答数量控制。
不过显而易见 效率上也会受到影响。
<ul><li><strong>半同步复制如何开启呢？</strong> <ul><li>在主机,从机安装半同步的插件 在mysql中执行 <strong>install plugin rpl_semi_sync_master soname ‘semisync_master.so’;</strong></li> <li>启动半同步: <strong>set global rpl_semi_sync_master_enabled=on;</strong></li> <li><strong>show plugins;</strong> 查看插件是否成功。如下图:
<img src="/assets/img/半同步复制.9aeb6e82.png"></li> <li><strong>stop slave io_thread; start slave io_thread;</strong> 重启I/o线程</li></ul></li></ul> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p><strong>如果需要开启启动半同步状态需要将如下参数写入配置文件</strong><br>
rpl_semi_sync_slave_enabled=on;<br>
rpl_semi_sync_master_enabled=on;<br> <strong>重要参数变量说明</strong><br>
Rpl_semi_sync_master_no_tx 代表没有成功接收slave提交的次数<br>
Rpl_semi_sync_master_yes_tx 代表成功接收slave事务回复的次数<br>
rpl_semi_sync_master_timeout参数默认为10s，即主库在超过10s未收到从库的回复会自动切换为异步模式。为了保障数据的安全性，可 以将该参数值调大。<br>
主库Rpl_semi_sync_master_status=off表示半同步复制停止，如果需要从异步复制模式恢复为半同步复制模式，只需要在从库重新开启I/O thread，命令：start slave io_thread</p></div></li></ul> <h3 id="读写分离有哪些实现方式"><a href="#读写分离有哪些实现方式" class="header-anchor">#</a> 读写分离有哪些实现方式？</h3> <p>对于读写分离前提就是主从复制。在一些并发，优化层面等场景读写分离又可以将效率提升一节儿。那么读写分离如何实现呢？
具体的实现细节就不多讲了，后续会推送到公众号可以前去搜索查看。</p> <ol><li><strong>配置多个数据源:</strong> <br>
基于spring/springboot 我们配置多个数据源，在业务逻辑层面根据情况来分开使用。
同时我们可以使用<strong>AbstractRoutingDataSource和自定义注解</strong>方式，更为方便的实现读写分离。</li> <li><strong>基于MySQL proxy代理的方式</strong><br>
在应用和数据库之间增加代理层，代理层接收应用对数据库的请求，根据不同请求类型转发到不同的实例，在实现读写分离的同时可以实现负载均衡。</li></ol> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>MySQL的代理最常见的是mysql-proxy、cobar、mycat、Atlas等。这种方式对于应用来说，MySQL Proxy是完全透明的，应用则只需要连接到MySQL Proxy的监听端口即可。当然，这样proxy机器可能成为单点失效，但完全可以使用多个proxy机器做为冗余，在应用服务器的连接池配置中配置到多 个proxy的连接参数即可。</p></div> <ul><li>mysql-proxy是一个轻量的中间代理，是官方提供的mysql中间件产品可以实现负载平衡，读写分离，failover等，依靠内部一个lua脚本实现读写语句的判断。项目地址： https://github.com/mysql/mysql-proxy ，该项目已经六七年没有维护了，官方也不建议应用于生成环境。</li> <li>cobar是阿里提供的一个中间件，已经停止更新。项目地址：https://github.com/alibaba/cobar</li> <li>mycat的前身就是cobar，活跃度比较高，完全使用java语言开发。 项目地址：https://github.com/MyCATApache/Mycat-Server ，该项目当前已经有8.3k的点赞量。</li> <li>moeba（变形虫）是阿里工程师陈思儒基于java开发的一款数据库读写分离的项目(读写分离只是它的一个小功能)，与MySQL官方的MySQL Proxy相比，作者强调的是amoeba配置的方便（基于XML的配置文件，用SQLJEP语法书写规则，比基于lua脚本的MySQL Proxy简单）。更多详细介绍请参考：https://www.biaodianfu.com/amoeba.html , 下载地址：https://sourceforge.net/projects/amoeba/ 。</li> <li>Atlas奇虎360的一个开源中间代理，是在mysql官方mysql-proxy 0.8.2的基础上进行了优化，增加一些新的功能特性。 项目地址: https://github.com/Qihoo360/Atlas ，该项目当前已经有4.4k的点赞量。</li></ul> <ol start="3"><li><strong>基于sharding-jdbc的方式</strong><br>
sharding-sphere是强大的读写分离、分表分库中间件，sharding-jdbc是sharding-sphere的核心模块。</li></ol></li></ul></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/Broad-CanDou/broad/edit/master/docs/八股文/01.Mysql/02.优化性能.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=Mysql" title="标签">#Mysql</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/05/29, 10:13:42</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/1ef4bf/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">索引</div></a> <a href="/pages/98f273/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Mysql事务</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/1ef4bf/" class="prev">索引</a></span> <span class="next"><a href="/pages/98f273/">Mysql事务</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/67ac4c/"><div>
            希尔排序
            <!----></div></a> <span class="date">07-26</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/66a9c1/"><div>
            插入排序
            <!----></div></a> <span class="date">07-24</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/91f6a9/"><div>
            选择排序
            <!----></div></a> <span class="date">07-23</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="wbz1833844" title="微信" target="_blank" class="iconfont icon-weixin"></a><a href="https://github.com/Broad-CanDou" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/wbzBroad" title="Gitee" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 202102-2022
    <span>Broad-Bean | <a href="https://beian.miit.gov.cn/" target="_blank">豫ICP备2022009421号-1</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.ddf09a0a.js" defer></script><script src="/assets/js/2.ea93b1fa.js" defer></script><script src="/assets/js/3.485ed5de.js" defer></script>
  </body>
</html>
